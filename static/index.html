<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Render Chat (FastAPI)</title>
<style>
:root{
  --bg: #f5f7fb;
  --left-bg: #ffffff;
  --right-bg: #93df87;
  --accent: #2e6cff;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
body{margin:0;padding:0;background:var(--bg);display:flex;align-items:center;justify-content:center;height:100vh}
.container{width:90%;max-width:1000px;height:90%;background:white;border-radius:12px;box-shadow:0 8px 30px rgba(20,30,60,0.12);display:flex;flex-direction:column;overflow:hidden}
.header{padding:1rem;border-bottom:1px solid #eee;display:flex;gap:1rem;align-items:center}
.header .title{font-weight:700;font-size:1.05rem}
.main{flex:1;padding:1rem;overflow:auto;display:flex;flex-direction:column;gap:0.5rem;background:linear-gradient(180deg,#fafcff,#f5f7fb)}
.message{display:flex;gap:0.5rem;align-items:flex-end}
.message .avatar{width:36px;height:36px;border-radius:50%}
.bubble{padding:0.6rem 0.9rem;border-radius:12px;max-width:70%;word-wrap:break-word}
.left .bubble{background:var(--left-bg);margin-right:auto}
.right{flex-direction:row-reverse}
.right .bubble{background:var(--right-bg);margin-left:auto}
.meta{font-size:0.75rem;color:#666;margin-top:0.25rem}
.inputbar{display:flex;gap:0.5rem;padding:0.75rem;border-top:1px solid #eee;align-items:center}
.inputbar input[type="text"]{flex:1;padding:0.6rem 0.8rem;border-radius:10px;border:1px solid #ddd;font-size:1rem}
.small{font-size:0.85rem;color:#666}
.sending{opacity:0.6;font-style:italic;font-size:0.85rem}
.message img.imgmsg{max-width:200px;border-radius:8px;display:block;margin-top:6px}
.controls{display:flex;gap:0.5rem;align-items:center;margin-left:auto}
.form-row{display:flex;gap:0.5rem;align-items:center}
</style>
</head>
<body>
<div class="container" role="application">
  <div class="header">
    <div class="title">Render Chat</div>
    <div style="margin-left:auto" id="auth-area">
      <!-- login/register UI toggled by JS -->
      <div id="logged-out">
        <input id="username" placeholder="username" />
        <input id="password" placeholder="password" type="password" />
        <button id="btn-register">Register</button>
        <button id="btn-login">Login</button>
      </div>
      <div id="logged-in" style="display:none">
        <span id="me-name" class="small"></span>
        <input id="icon-url" placeholder="icon URL (or upload)" style="width:220px" />
        <input id="upload-file" type="file" accept="image/*" />
        <button id="btn-logout">Logout</button>
      </div>
    </div>
  </div>

  <div id="main" class="main" aria-live="polite"></div>

  <div class="inputbar">
    <input id="input" type="text" placeholder="Type a message..." />
    <input id="imgfile" type="file" accept="image/*" />
    <button id="send">Send</button>
  </div>
</div>

<script>
const API_BASE = "";
const WS_BASE = (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
const main = document.getElementById('main');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');
const imgfile = document.getElementById('imgfile');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const btnRegister = document.getElementById('btn-register');
const btnLogin = document.getElementById('btn-login');
const loggedInArea = document.getElementById('logged-in');
const loggedOutArea = document.getElementById('logged-out');
const meNameSpan = document.getElementById('me-name');
const iconUrlInput = document.getElementById('icon-url');
const uploadFileInput = document.getElementById('upload-file');
const btnLogout = document.getElementById('btn-logout');

let token = localStorage.getItem('chat_token') || null;
let myUserId = localStorage.getItem('chat_user_id') || null;
let ws = null;
let pending = {}; // clientId -> DOM element
let messages = {}; // server_id -> true

function showLoggedIn() {
  loggedOutArea.style.display = 'none';
  loggedInArea.style.display = '';
  meNameSpan.textContent = localStorage.getItem('chat_username') || 'me';
  iconUrlInput.value = localStorage.getItem('chat_icon') || '';
}

function showLoggedOut() {
  loggedOutArea.style.display = '';
  loggedInArea.style.display = 'none';
}

// auth
btnRegister.addEventListener('click', async () => {
  const u = usernameInput.value.trim();
  const p = passwordInput.value;
  if (!u || !p) return alert("enter username+password");
  const fd = new FormData();
  fd.append('username', u);
  fd.append('password', p);
  const res = await fetch(API_BASE + '/register', {method:'POST', body: fd});
  if (!res.ok) {
    alert('register failed');
    return;
  }
  const j = await res.json();
  token = j.token;
  myUserId = j.user_id;
  localStorage.setItem('chat_token', token);
  localStorage.setItem('chat_user_id', myUserId);
  localStorage.setItem('chat_username', u);
  showLoggedIn();
  connectWS();
});

btnLogin.addEventListener('click', async () => {
  const u = usernameInput.value.trim();
  const p = passwordInput.value;
  if (!u || !p) return alert("enter username+password");
  const fd = new FormData();
  fd.append('username', u);
  fd.append('password', p);
  const res = await fetch(API_BASE + '/login', {method:'POST', body: fd});
  if (!res.ok) {
    alert('login failed');
    return;
  }
  const j = await res.json();
  token = j.token;
  myUserId = j.user_id;
  localStorage.setItem('chat_token', token);
  localStorage.setItem('chat_user_id', myUserId);
  localStorage.setItem('chat_username', u);
  showLoggedIn();
  connectWS();
});

btnLogout.addEventListener('click', () => {
  token = null; myUserId = null;
  localStorage.removeItem('chat_token');
  localStorage.removeItem('chat_user_id');
  localStorage.removeItem('chat_username');
  showLoggedOut();
  if (ws) ws.close();
  ws = null;
  main.innerHTML = '';
});

// upload icon
uploadFileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const fd = new FormData();
  fd.append('file', f);
  fd.append('token', token || '');
  fd.append('type', 'icon');
  const res = await fetch(API_BASE + '/upload', {method:'POST', body: fd});
  const j = await res.json();
  iconUrlInput.value = j.url;
  localStorage.setItem('chat_icon', j.url);
  alert('icon uploaded');
});

// upload image for message helper
async function uploadImageFile(file) {
  if (!file) return null;
  const fd = new FormData();
  fd.append('file', file);
  fd.append('token', token || '');
  fd.append('type', 'image');
  const res = await fetch(API_BASE + '/upload', {method:'POST', body: fd});
  if (!res.ok) return null;
  const j = await res.json();
  return j.url;
}

// connect websocket
function connectWS() {
  if (!token) {
    console.warn("‚ùå No token. Cannot connect WebSocket.");
    return;
  }

  if (ws) ws.close();

  const url = WS_BASE + '/ws?token=' + encodeURIComponent(token);
  console.log("üåê Connecting WebSocket:", url);

  ws = new WebSocket(url);

  ws.addEventListener('open', () => {
    console.log('%cüü¢ WS OPEN', 'color: green; font-weight: bold;');
  });

  ws.addEventListener('error', (err) => {
    console.error('‚ùå WS ERROR:', err);
  });

  ws.addEventListener('close', (event) => {
    console.warn(
      `üî¥ WS CLOSED (code=${event.code}, reason=${event.reason})`
    );
    // 403 „ÅÆ„Å®„Åç„Å™„Å©
    if (event.code === 1006) {
      console.error("‚ö†Ô∏è WebSocket closed (1006). Most likely CORS or token rejected.");
    }
  });

  ws.addEventListener('message', (ev) => {
    console.log("üì• WS MESSAGE:", ev.data);
    try {
      const d = JSON.parse(ev.data);
      handleWSMessage(d);
    } catch (e) {
      console.error("‚ùå WS JSON parse error:", e, ev.data);
    }
  });
}

function handleWSMessage(d) {
  console.log("üîç Parsed WS msg:", d);

  if (d.type === 'history') {
    main.innerHTML = '';
    d.messages.forEach(m => {
      if (!messages[m.id]) {
        addMessageEl(m, m.user_id == myUserId ? 'right' : 'left');
      }
    });
    return;
  }

  if (d.type === 'message') {
    if (String(d.message.user_id) === String(myUserId)) {
      console.log("üü¶ Ignoring echo of my message");
      return;
    }
    addMessageEl(d.message, 'left');
    return;
  }

  if (d.type === 'ack') {
    console.log("üì® ACK:", d);
    const el = pending[d.client_id];
    if (el) {
      el.dataset.id = d.server_id;
      const s = el.querySelector('.sending');
      if (s) s.remove();
      messages[d.server_id] = true;
      delete pending[d.client_id];
    }
    return;
  }

  if (d.type === 'edit') {
    console.log("‚úèÔ∏è EDIT:", d);
    // „Åì„Åì„ÅØÂÖÉ„ÅÆ„Åæ„Åæ
    return;
  }

  if (d.type === 'read') {
    console.log("üëÅ READ:", d);
    return;
  }

  console.warn("‚ö†Ô∏è Unknown WS message:", d);
}


// add message DOM
function addMessageEl({id, user_id, username, icon, text, image, time}, side) {
  if (id && messages[id]) return null;
  if (id) messages[id] = true;

  const row = document.createElement('div');
  row.className = 'message ' + (side === 'right' ? 'right' : 'left');
  row.dataset.id = id || '';

  const avatar = document.createElement('img');
  avatar.className = 'avatar';
  avatar.src = icon || '/static/default-avatar.png';
  avatar.onerror = () => { avatar.src = '/static/default-avatar.png'; };

  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  const who = document.createElement('div');
  who.innerHTML = '<strong>' + (username || 'User') + '</strong>';
  const txt = document.createElement('div');
  txt.className = 'text';
  txt.textContent = text || '';
  bubble.appendChild(who);
  bubble.appendChild(txt);

  if (image) {
    const img = document.createElement('img');
    img.className = 'imgmsg';
    img.src = image;
    bubble.appendChild(img);
  }

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = time ? new Date(time).toLocaleTimeString() : '';

  const controls = document.createElement('div');
  controls.className = 'controls';

  // if this is my own message and not yet acked, show sending
  if (side === 'right' && !id) {
    const s = document.createElement('div');
    s.className = 'sending';
    s.textContent = 'Sending...';
    bubble.appendChild(s);
  }

  row.appendChild(avatar);
  row.appendChild(bubble);
  row.appendChild(meta);
  main.appendChild(row);
  // scroll to bottom
  main.scrollTop = main.scrollHeight;
  return row;
}

// send message
sendBtn.addEventListener('click', async () => {
  const text = input.value.trim();
  if (!text && !imgfile.files[0]) return;
  let imageUrl = null;
  if (imgfile.files[0]) {
    imageUrl = await uploadImageFile(imgfile.files[0]);
    imgfile.value = '';
  }
  const clientId = 'c-' + Math.random().toString(36).slice(2,9);
  // optimistic render
  const el = addMessageEl({id:'', user_id: myUserId, username: localStorage.getItem('chat_username'), icon: localStorage.getItem('chat_icon'), text, image: imageUrl}, 'right');
  pending[clientId] = el;
  // send ws
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({type:'message', id: clientId, text, image: imageUrl}));
  } else {
    alert('not connected');
  }
  input.value = '';
});

// helper: upload image via /upload
async function uploadImageFile(file) {
  const fd = new FormData();
  fd.append('file', file);
  fd.append('token', token || '');
  fd.append('type', 'image');
  const res = await fetch(API_BASE + '/upload', {method:'POST', body: fd});
  if (!res.ok) { alert('upload failed'); return null; }
  const j = await res.json();
  return j.url;
}

// initialize
if (token && myUserId) {
  showLoggedIn();
  connectWS();
} else {
  showLoggedOut();
}

// small UX: send enter
input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') sendBtn.click();
});
sendBtn.addEventListener('click', async () => {
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    console.error("‚ùå WS not open. readyState =", ws ? ws.readyState : "no ws");
    alert('not connected');
    return;
  }

  const text = input.value.trim();
  if (!text && !imgfile.files[0]) return;

  let imageUrl = null;
  if (imgfile.files[0]) {
    imageUrl = await uploadImageFile(imgfile.files[0]);
    imgfile.value = '';
  }

  const clientId = 'c-' + Math.random().toString(36).slice(2,9);
  const el = addMessageEl({
    id: '',
    user_id: myUserId,
    username: localStorage.getItem('chat_username'),
    icon: localStorage.getItem('chat_icon'),
    text,
    image: imageUrl
  }, 'right');

  pending[clientId] = el;

  ws.send(JSON.stringify({
    type: 'message',
    id: clientId,
    text,
    image: imageUrl
  }));

  input.value = '';
});

</script>
</body>
</html>
